---
title: "Exploring temporal trends"
author: "The Freemasons"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_height: 14
    fig_width: 10
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Temporal trends}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  outwidth = "100%",
  fig.width = 8, fig.height = 6)
```
  
  
# Loading packages and data
  
```{r}
library(learningtower)
library(tidyverse)
library(patchwork)
library(brolgar)
library(gghighlight)
library(ggrepel)
library(brolgar)
library(tsibble)

data(student)
data(countrycode)
theme_set(theme_classic(18) +
            theme(legend.position = "bottom"))
```

# Time series visaulisation

We will first visualise the time series trend of countries, regardless of when and how long they have participated in the PISA study. 

```{r}
w_mean = function(x, w){weighted.mean(x = x, w = w, na.rm=TRUE)}

stu_summ = student %>% 
  group_by(year, country) %>%
  summarise_at(.vars = vars(math, read, science), 
               .funs = list(wmean = ~w_mean(., w = stu_wgt),
                            min = ~min(., na.rm = TRUE), 
                            max = ~max(., na.rm = TRUE))) %>% 
  ungroup() %>% 
  dplyr::mutate(year = year %>% as.character() %>% as.integer)


stu_wmean_long = stu_summ %>%
  select(year, country, contains("wmean")) %>% 
  pivot_longer(cols = contains("wmean"), 
                      names_to = "wmean_names",
                      values_to = "wmean_values")

stu_wmean_long %>% 
  ggplot(aes(x = year, y = wmean_values, group = country)) +
  geom_line() +
  facet_wrap(~wmean_names) +
  labs(x = "Year", y = "Weighted mean values")


## Uncomment this to make interactive
# library(plotly)
# ggplotly()
```


## Australia, New Zealand, Indonesia

We focus on three countries here. The dark line is the weighted mean score of each country for each subject. The shading indicates the min and max score of a given year. 

```{r}
stu_summ_long2 = stu_summ %>% 
  filter(country %in% c("AUS", "NZL", "IDN")) %>% 
  pivot_longer(cols = math_wmean:science_max, 
               names_to = "names",
               values_to = "values") %>% 
  separate(col = names, into = c("subject", "statistics"), sep = "_") %>% 
  pivot_wider(names_from = "statistics",
                     values_from = "values")
stu_summ_long2


stu_summ_long2 %>% 
  ggplot(aes(x = year, y = wmean)) +
  geom_ribbon(aes(ymin = min, ymax = max), fill = "grey70") +
  geom_line(colour = "black", size = 2) +
  facet_grid(subject~country, labeller = label_both) + 
  labs(x = "Year", y = "Test score values")
```

# `brolgar` visualisations 

## Calculating slope

There are many countries/regions who did not participate in all 7 PISA countries. As we are interested in calculating linear models, we will retain only those countries/regions participated in 5 or more studies. 

```{r}
complete_nations = stu_summ %>% 
  group_by(country) %>% filter(n() >= 5) %>%
  ungroup() %>%
  mutate(year_subtract = year - 2000) %>% 
  as_tsibble(key = country, index = year_subtract)

math_slope = complete_nations %>% ## Filter for countries participated in all 7 PISA studies
  select(
    year_subtract, 
    country, 
    math_wmean) %>% 
  key_slope(math_wmean ~ year_subtract) %>% 
  left_join(countrycode, by = "country")

math_slope %>% 
  ggplot(aes(x = .intercept, y = .slope_year_subtract)) +
  geom_point() +
  geom_label_repel(aes(label = country_name)) +
  labs(x = "Weighted mean math score in 2000", 
       y = "Avg. increase in weighted mean score every year")


math_slope_near <- math_slope %>%
  keys_near(key = country, var = .slope_year_subtract)

math_slope_near
```

## Highlighting monotone countries for subjects

```{r}
# math_features <- complete_nations %>% 
#   features(math_wmean, feat_brolgar)
# 
# math_features

feature_monotone = complete_nations %>%
  features_at(.var = vars(math_wmean, read_wmean, science_wmean), 
              features = feat_monotonic) %>% 
  dplyr::select(country, contains("increase"), contains("decrease"))

feature_monotone_long = feature_monotone %>% 
  pivot_longer(cols = -country,
               names_to = "names", 
               values_to = "monotone_value") %>% 
  separate(col = names, into = c("subject", "direction"), sep = "_(?!.*_)")

plot_tbl = complete_nations %>% 
  as_tibble() %>% 
  select(year, country, math_wmean, read_wmean, science_wmean) %>% 
  pivot_longer(cols = contains("_wmean"),
               names_to = "subject", 
               values_to = "wmean_value") %>%
  left_join(feature_monotone_long, by = c("country", "subject")) %>% 
  left_join(countrycode, by = "country")

plot_tbl

plot_tbl %>% 
  ggplot(aes(x = year,
             y = wmean_value,
             group = interaction(country, subject))) +
  geom_line() + 
  gghighlight::gghighlight(monotone_value, label_key = country_name) +
  facet_grid(direction~subject) +
  labs(x = "Year", y = "Weighted means")
```

# Session info
```{r}
sessionInfo()
```

