---
title: "Exploring temporal trends"
author: "The Freemasons"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Temporal trends}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
  knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  outwidth = "100%",
  fig.width = 8, fig.height = 6)
```
  
  
# Loading packages and data
  
```{r}
library(learningtower)
library(tidyverse)
library(patchwork)
library(brolgar)
library(gghighlight)
library(ggrepel)
library(brolgar)
library(tsibble)

data(student)
```

# Time series visaulisation

We will first visualise the time series trend of countries, regardless of when and how long they have participated in the PISA study. 

```{r, fig.height=9}
w_mean = function(x, w){weighted.mean(x = x, w = w, na.rm=TRUE)}

stu_summ = student %>% 
  group_by(year, country) %>%
  summarise_at(.vars = vars(math, read, science), 
               .funs = list(wmean = ~w_mean(., w = stu_wgt),
                            min = ~min(., na.rm = TRUE), 
                            max = ~max(., na.rm = TRUE))) %>% 
  ungroup() %>% 
  dplyr::mutate(year = year %>% as.character() %>% as.integer)


stu_wmean_long = stu_summ %>%
  dplyr::select(year, country, contains("wmean")) %>% 
  tidyr::pivot_longer(cols = contains("wmean"), 
                      names_to = "wmean_names",
                      values_to = "wmean_values")

stu_wmean_long %>% 
  ggplot(aes(x = year, y = wmean_values, group = country)) +
  geom_line() +
  facet_wrap(~wmean_names) +
  labs(x = "Year", y = "Weighted mean values")


## Uncomment this to make interactive
# library(plotly)
# ggplotly()
```


## Australia, New Zealand, Indonesia

We focus on three countries here. The dark line is the weighted mean score of each country for each subject. The shading indicates the min and max score of a given year. 

```{r}
stu_summ_long2 = stu_summ %>% 
  dplyr::filter(country %in% c("AUS", "NZL", "IDN")) %>% 
  tidyr::pivot_longer(cols = math_wmean:science_max, 
                      names_to = "names",
                      values_to = "values") %>% 
  tidyr::separate(col = names, into = c("subject", "statistics"), sep = "_") %>% 
  tidyr::pivot_wider(names_from = "statistics",
                     values_from = "values")
stu_summ_long2


stu_summ_long2 %>% 
  ggplot(aes(x = year, y = wmean)) +
  geom_ribbon(aes(ymin = min, ymax = max), fill = "grey70") +
  geom_line(colour = "black", size = 2) +
  facet_grid(subject~country, labeller = label_both) + 
  labs(x = "Year", y = "Test score values")
```

# `brolgar` visualisations 

## Calculating slope

<!-- There are many countries who did not participate in all 7 PISA countries. As we are interested in calculating linear models, we will filter out these countries due to the small number of observations.  -->

```{r}
complete_nations = stu_summ %>% 
  group_by(country) %>% filter(n() == 7) %>%
  ungroup() %>%
  dplyr::mutate(year_subtract = year - 2000) %>% 
  as_tsibble(key = country, index = year_subtract)

math_slope = complete_nations %>% ## Filter for countries participated in all 7 PISA studies
  dplyr::transmute(
    year_subtract, 
    country, 
    math_wmean) %>% 
  key_slope(math_wmean ~ year_subtract)

math_slope %>% 
  ggplot(aes(x = .intercept, y = .slope_year_subtract)) +
  geom_point() +
  geom_label_repel(aes(label = country)) +
  labs(x = "Weighted mean math score in 2000", 
       y = "Avg. increase in weighted mean score every year")


math_slope_near <- math_slope %>%
  keys_near(key = country, var = .slope_year_subtract)

math_slope_near

# math_features <- complete_nations %>% 
#   features(math_wmean, feat_brolgar)
# 
# math_features

math_monotone = complete_nations %>%
  features(math_wmean, feat_monotonic)

math_monotone

p1 = math_monotone %>% 
  right_join(complete_nations, by = "country") %>%
  ggplot(aes(x = year,
             y = math_wmean,
             group = country)) +
  geom_line() + 
  gghighlight::gghighlight(increase) +
  labs(x = "Year", 
       y = "Weighted mean Maths scores", 
       title = "Highlight monotone increasing countries")


p2 = math_monotone %>% 
  right_join(complete_nations, by = "country") %>%
  ggplot(aes(x = year,
             y = math_wmean,
             group = country)) +
  geom_line() + 
  gghighlight::gghighlight(decrease) +
  labs(x = "Year", 
       y = "Weighted mean Maths scores", 
       title = "Highlight monotone decreasing countries")

p1 / p2
```
